dependencies:
  post:
    - sudo apt-get -y update
    - sudo apt-get -y install coreutils qemu virtualbox gawk sed curl wget
    - cd /tmp && wget https://github.com/tcnksm/ghr/releases/download/v0.5.4/ghr_v0.5.4_linux_amd64.zip && unzip ghr_v0.5.4_linux_amd64.zip && sudo mv ./ghr /usr/local/bin/
compile:
  override:
    - cd dist && source ../scripts/env/debian-8 && ../scripts/create_images_from_qcow2.sh
    - cd dist && source ../scripts/env/ubuntu-1604 && ../scripts/create_images_from_vmdk.sh xenial-server-cloudimg-amd64:
        timeout: 1200
    - cd dist && source ../scripts/env/centos-7 && ../scripts/create_images_from_qcow2.sh
    # - cd dist && source ../scripts/env/rancheros && ../scripts/create_images_from_qcow2.sh
    # - cd dist && source ../scripts/env/coreos-stable && ../scripts/create_images_from_qcow2.sh
    - cd dist && ls -l
test:
  post:
    - echo 'no tests yet.'
deployment:
  release:
    branch: master
    commands:
    # publish assets to github
    - rm -f dist/.gitignore
    # temporary workaround
    # for some reason with this file we see ghr return 422 Validation Failed [{Resource:ReleaseAsset Field:size Code:custom Message:size is not included in the list}]
    - rm -f CentOS-7-x86_64-GenericCloud.img
    - ghr -t "$GITHUB_TOKEN" -u "$CIRCLE_PROJECT_USERNAME" -r "$CIRCLE_PROJECT_REPONAME" -prerelease -delete "v0.0.$CIRCLE_BUILD_NUM" dist/
